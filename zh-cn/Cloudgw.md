
!> **更新时间：** {docsify-updated} 


## 云设备  

### 简介
作为第三方云服务设备接入的依据和输入。

### 术语和定义  

| **名称** | **解释** |  
| :-----: |:------:|  
|Haier U+云平台|为物联网云平台，提供设备和应用的接入服务、数据分析服务等|   

### 公共说明  

#### 整体架构与接入流程介绍  

Iot云平台支持第三方设备通过云云对接的方式接入，整体架构如下图  

![架构图][framework]  


设备通过第三方云服务接入，首先需要通过以下流程对第三方云服务进行注册或配置：  
  **1.	线上申请使用的SystemID和SystemKey (海极网申请)；**  
  **2.	线上申请设备使用的uPlusID与DeviceKey（海极网申请）；**  
  **3.	线下在Iot平台配置第三方云服务回调地址（海极网申请）；**  
  **4.	线下在Iot平台配置第三方云服务Ip白名单（海极网申请）；**

第三方云服务注册配置完成后，设备即可通过本接口文档接入，设备接入及通信流程如下图：  

![流程图][flow]  


第三方云服务需要实现并线下注册的回调接口如下表：

<table>
<tr>
    <td bgcolor="#3399FF"><b>回调类型</b></td>
 	<td bgcolor="#3399FF"><b>必须实现</b></td>
	<td bgcolor="#3399FF"><b>接口定义</b></td>
	<td bgcolor="#3399FF"><b>说明</b></td>
</tr>
<tr>
    <td>设备信息查询</td>
	<td>是</td>
    <td>设备信息查询</td>
	<td>Iot平台通过本接口来主动向第三方云服务定期同步设备信息。</td>

</tr>
<tr>
    <td>设备属性读</td>
	<td>否</td>
    <td>设备属性读</td>
	<td rowspan="3">Iot平台通过本接口将APP或APPServer对设备的控制指令发送给第三方云服务。如果不实现本接口，则对所有第三方云服务发送的远程控制请求会全部失败。</td>
</tr>
<tr>
    <td>设备属性写</td>
	<td>否</td>
    <td>设备属性写</td>
</tr>
<tr>
    <td>设备操作</td>
	<td>否</td>
    <td>设备操作</td>
</tr>
<table>



#### HTTP接入地址定义  

本文档提供的所有接口仅支持https协议请求，接入地址如下：  
`https://uws.haier.net:443/cloudgw/接口地址`   
访问非生产环境时，需要配置第三方云服务DNS，以便是域名指向对应的环境。  

#### HTTP Header参数定义  

第三方云服务调用Iot平台HTTPS接口时，需要携带以下HTTP Header参数：  


参数名|类型|位置|必填|说明
:-|:-:|:-:|:-:|:-
systemId|String|Header|是|系统ID。40位以内字符，系统全局唯一标识  
sequenceId|String|Header|是|报文流水(客户端唯一)客户端交易流水号。6-32 位。由客户端自行定义，自行生成。建议使用不带中横线的UUID，例如：e3480efdef6a410f9f60801707671bcc  
sign|String|Header|是|对请求进行签名运算产生的签名 [签名算法][sign]   
timestamp|String|Header|是|Unix时间戳，当前UTC标准时间，精确到毫秒，例如：1557900146503    
Content-Type|String|Header|是|本接口Payload内容仅支持UTF-8编码的Json格式数据，值必须为application/json;charset=UTF-8
   

请求头信息样例（其中#为占位符，不代表具体含义）：  


	Connection: keep-alive  
	systemId: ######    
	deviceId: ######  
	sequenceId: e3480efdef6a410f9f60801707671bcc  
	sign: bb2a5c1e432eac8bea8eecb89b408937382e7e95486ee0a60944a46504fa0015 （此字段需计算）  
	timestamp: 1557900146503  
	Content-Type: application/json;charset=UTF-8  


#### 错误码定义  

##### 公共错误码  

错误码W00001~W10000及部分其他错误码，为公共错误码，及Iot平台的接口与第三方云服务实现的回调接口都会出现的错误码，定义如下：  

| **错误码** | **描述** |
| :-------: |:-----:|
|00000|成功|
|W00001|通用错误，表示暂时未定义或无法区分的错误。|
|W00002|内部错误，表示系统内部发生且不对外开放的错误。正常业务下不会返回该错误。|
|W00003|格式错误，即Payload不是UTF-8编码的Json格式|
|W00004|参数错误，即接口Payload中某必填字段不存在、某字段值不合法等|
|W01001|sequenceId错误，即HTTP Header中的sequenceId字段为空或者超长|
|W01002|时间戳错误，即时间戳与当前时间相差较大|
|C00001|systemId错误，即HTTP Header中的systemId字段为空或在Iot平台不存在|
|C00002|无访问授权，指设备云接入网关未在UWS接口注册|
|D00001|HTTP Header签名校验错误|

以上错误码在后续每一个接口中均可能返回，后面章节接口中，不再单独描述。

##### Iot平台接口错误码  

错误码W10000~W20000，为仅Iot平台的接口出现的错误码，定义如下：  

| **错误码** | **描述** |
| :-------: |:-----:|
|W10001|设备未注册|
|W10002|设备注册时，U+产品编号不存在|
|W10003|设备注册时，设备产品信息签名错误，通常为deviceKey错误导致|
|W10004|设备绑定时，用户token无效|
|W10005|设备绑定时，用户绑定时间窗未开启|
|W10006|设备绑定时，用户已达到绑定设备数量上限|
|W10007|设备控制应答sn错误|

##### 第三方云服务回调接口错误码 

错误码W20000~W30000，为仅第三方云服务实现的回调接口出现的错误码，定义如下：  


| **错误码** | **描述** |
| :-------: |:-----:|
|W20010|设备不存在|

##### 第三方云设备控制异步应答错误码   

设备控制异步应答错误码为整数类型，该错误码会直接返回给App处理，定义如下：  

| **错误码** | **描述** |
| :-------: |:-----:|
|0 |成功。|
|1 |通用错误码，表示暂时未定义或无法区分的错误。|
|3 |格式错误，表示PayLoad消息体格式错误，例如不是合法的Json格式。|
|4 |缺少参数，表示PayLoad消息体中缺少部分必填字段。|
|11|控制指令执行超时。|
|12|无效命令。主要指命令执行逻辑错误。例如关机状态下再关机等。|
|13|非法值。主要指设备操作的操作值非法。例如温度设置的温度值越界。|
|17|不支持的命令。主要指读属性或写属性请求时，设备无此属性，或者操作时，设备不支持此操作。|

### 设备接入相关接口  

#### 设备注册（调用Iot平台）
> 设备接入Iot平台，需要先在Iot平台注册，否则后续对该设备的所有动作均会失败。设备可以重复注册，machineId是设备物理唯一标识，对于同一个systemId的同一个machineId，重复注册时返回的deviceId始终是相同的，设备信息（uPlusID、online）也会直接覆盖该设备的原有信息。


##### 1、接口定义
?> **接入地址：** `/v1/dev/reg` </br>
**HTTP Method：** POST

**输入参数**

参数名|类型|位置|必填|说明
:-|:-:|:-:|:-:|:-
machineId|String|Body|是|要注册的设备的物理唯一标识，该标识在同一systemId下需唯一。字符串长度范围：1~32。对于WIFI类设备，建议使用MAC地址，格式为全大写无连接符十六进制字符串，例如CC1122334455。对于2G或NB类设备，建议使用IMEI地址，格式为全数据字符串，例如860123456789876。
uPlusID|String|Body|是|U+产品编号，接入U+产品的唯一标识，由U+统一定义。字符串长度范围：64。
devSign|String|Body|是|设备产品信息签名，用于设备身份认证，全小写十六进制字符串，字符串长度范围：64。例如：996a4a51cfc228f7d5044319767d6f792f106460e86a9050b79dcee0a6dd31d9 算法如下（+表示字符串拼接）：SHA256（machineId+uPlusID+deviceKey+ timestamp）其中：deviceKey为海极网创建uPlusID时分配；timestamp为HTTP Header中的时间戳字段；
online|Boolean|Body|是|设备当前在线状态。true为在线；false为离线；


**输出参数:**  


参数名|类型|位置|必填|说明
:-|:-:|:-:|:-:|:-
retCode|String|Body|是|返回码，00000代表请求成功，其它值代表错误 见“错误码定义”章节。可返回错误：公共错误码、W10002、W10003
retInfo|String|Body|是|错误描述信息，本描述信息仅是用于调试的返回信息，不支持国际化，不能直接显示在UI上。字符串长度范围：0~256。详细错误情况以retCode在本接口文档中对应描述为准。
deviceId|String|Body|是|注册成功后Iot平台分配的设备ID。字符串长度范围：1~32。



##### 2、请求样例

**请求样例**

```
请求地址：https://uws.haier.net/cloudgw/v1/dev/reg
Body：
	{
    "deviceMac" : "***",
    "uPlusID" : "***",
    "devSign" : "***",
    "online" : true | false
	}

```
**请求应答**
```
{
    "retCode" : "00000",
    "retInfo" : "***",
    "deviceId" : "***"
}
```















[^-^]:常用图片注释
[framework]:_media/_Cloudgw/framework.png 
[sign]:https://haier-iot.github.io/guide/#/zh-cn/Standard/Basic?id=%e7%ad%be%e5%90%8d%e7%ae%97%e6%b3%95
[flow]:_media/_Cloudgw/flow.png 











